#!/bin/bash

# Pre-commit hook to run Giphy migration script
# This script runs before each commit to migrate any new Giphy links to R2

set -e

echo "ğŸ”„ Running Giphy to R2 migration..."

# Check if required environment variables are set
if [ -z "$R2_ACCESS_KEY_ID" ] || [ -z "$R2_SECRET_ACCESS_KEY" ] || [ -z "$R2_ENDPOINT_URL" ] || [ -z "$R2_BUCKET_NAME" ]; then
    echo "âš ï¸  Warning: R2 credentials not configured. Skipping Giphy migration."
    echo "   Configure R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY, R2_ENDPOINT_URL, and R2_BUCKET_NAME in .env"
    exit 0
fi

# Install Python dependencies if not already installed
if ! python3 -c "import boto3, requests, dotenv" 2>/dev/null; then
    pwd
    echo "ğŸ“¦ Installing Python dependencies..."
    if command -v uv >/dev/null 2>&1; then
        uv pip install -r scripts/requirements.txt
    else
        pip3 install -r scripts/requirements.txt
    fi
fi

# Run the migration script
echo "ğŸš€ Starting migration..."
if python3 scripts/migrate_giphy_to_r2.py; then
    echo "âœ… Giphy migration completed successfully"
    
    # Check if any files were modified by the migration
    if ! git diff --quiet; then
        echo "ğŸ“ Migration updated some files. Adding them to the commit..."
        git add src/content/blog/
    fi
else
    echo "âŒ Giphy migration failed"
    exit 1
fi

echo "âœ¨ Pre-commit hook completed"